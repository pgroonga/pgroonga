name: macOS
on:
  push:
    branches:
      - main
    tags:
      - "*"
  pull_request:
    branches:
      - "*"
  schedule:
    - cron: |
        0 0 * * *
jobs:
  test:
    if: >-
      github.event_name != 'schedule' ||
      (github.event_name == 'schedule' &&
       github.repository_owner == 'pgroonga')
    name: Test
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        postgresql-version:
          - "12"
          - "13"
          - "14"
          - "15"
          - "16"
    env:
      PGROONGA_BENCHMARK_GEMFILE: ${{ github.workspace }}/pgroonga-benchmark/Gemfile
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/checkout@v4
        with:
          repository: pgroonga/benchmark
          path: pgroonga-benchmark
      - name: Install dependency
        run: |
          sed \
            -i '' \
            -e 's/postgresql/postgresql@${{ matrix.postgresql-version }}/g' \
            Brewfile
          brew bundle
      - name: Prepare PostgreSQL
        run: |
          echo "max_prepared_transactions = 1" >> \
            $(brew --prefix)/var/postgresql@${{ matrix.postgresql-version }}/postgresql.conf
          brew services start postgresql@${{ matrix.postgresql-version }}
      - name: Run regression test
        run: |
          # TODO: Remove me when groonga formula enables libstemmer
          rm sql/full-text-search/text/options/token-filters/custom.sql
          rm sql/full-text-search/text/single/declarative-partitioning.sql
          # TODO: Remove me when groonga formula is 13.1.1 or later
          rm sql/term-search/varchar-array/prefix-condition/weights/bitmapscan.sql
          rm sql/term-search/varchar-array/prefix-condition/weights/indexscan.sql
          rm sql/term-search/text-array/prefix-condition/weights/bitmapscan.sql
          rm sql/term-search/text-array/prefix-condition/weights/indexscan.sql
          PG_CONFIG=$(brew --prefix postgresql@${{ matrix.postgresql-version }})/bin/pg_config \
            test/run-sql-test.sh
        env:
          HAVE_XXHASH: "1"
          MSGPACK_PACKAGE_NAME: "msgpack-c"
          SUPPRESS_LOG: "no"
      - name: Show diff
        if: failure()
        run: |
          cat regression.diffs
      - name: Show pgroonga.log
        if: failure()
        run: |
          cat \
            $(brew --prefix)/var/postgresql@${{ matrix.postgresql-version }}/pgroonga.log
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ruby
          bundler-cache: true
      - uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/red-datasets
          key: red-datasets-macos
      - name: Run unit test
        run: |
          PATH="$(brew --prefix postgresql@${{ matrix.postgresql-version }})/bin:$PATH" \
            bundle exec ruby \
              -I${{ github.workspace }}/pgroonga-benchmark/lib \
              test/run-test.rb \
              --ignore-testcase=/CrashSafer/ \
              --ignore-testcase=/StreamingReplication/ \
              --verbose
