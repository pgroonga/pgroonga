CREATE TABLE infection_numbers_influenza (
    country varchar(16) NOT NULL,
    prefecture varchar(4) NOT NULL,
    city varchar(3) NOT NULL,
    n_infection varchar(205),
    city_code varchar(5) NOT NULL,
    remarks varchar(200)
)
PARTITION BY LIST (city_code);
CREATE TABLE infection_numbers_influenza_20_01 PARTITION OF infection_numbers_influenza FOR VALUES IN ('20-01');
CREATE TABLE infection_numbers_influenza_20_02 PARTITION OF infection_numbers_influenza FOR VALUES IN ('20-02');
CREATE TABLE infection_numbers_influenza_20_03 PARTITION OF infection_numbers_influenza FOR VALUES IN ('20-03');
CREATE TABLE infection_numbers_influenza_20_04 PARTITION OF infection_numbers_influenza FOR VALUES IN ('20-04');
CREATE TABLE infection_numbers_influenza_21_01 PARTITION OF infection_numbers_influenza FOR VALUES IN ('21-01');
CREATE TABLE infection_numbers_influenza_21_02 PARTITION OF infection_numbers_influenza FOR VALUES IN ('21-02');
CREATE TABLE infection_numbers_influenza_21_03 PARTITION OF infection_numbers_influenza FOR VALUES IN ('21-03');
CREATE TABLE infection_numbers_influenza_21_04 PARTITION OF infection_numbers_influenza FOR VALUES IN ('21-04');
CREATE TABLE infection_numbers_influenza_22_01 PARTITION OF infection_numbers_influenza FOR VALUES IN ('22-01');
CREATE TABLE infection_numbers_influenza_22_02 PARTITION OF infection_numbers_influenza FOR VALUES IN ('22-02');
CREATE TABLE infection_numbers_influenza_22_03 PARTITION OF infection_numbers_influenza FOR VALUES IN ('22-03');
CREATE TABLE infection_numbers_influenza_22_04 PARTITION OF infection_numbers_influenza FOR VALUES IN ('22-04');
INSERT INTO infection_numbers_influenza_20_04 VALUES ('Japan','Mie','Ise','134','20-04','age: 30, gender:male, overseas travel history: true');
INSERT INTO infection_numbers_influenza_21_04 VALUES ('Germany','BER','BER','221','21-04','age: 50, gender:male, overseas travel history: false');
INSERT INTO infection_numbers_influenza_22_04 VALUES ('U.S.A','NY','NY','10221','22-04','age: 10, gender:male, overseas travel history: false');
CREATE INDEX remarks_index ON infection_numbers_influenza USING pgroonga (remarks);
\pset format unaligned
EXPLAIN (COSTS OFF)
SELECT t1.n_infection, t1.remarks
  FROM infection_numbers_influenza t1
  INNER JOIN infection_numbers_influenza t2
    ON t1.city = t2.prefecture
 WHERE t1.remarks  &@~ 'age';
QUERY PLAN
Hash Join
  Hash Cond: ((t1.city)::text = (t2.prefecture)::text)
  ->  Append
        ->  Seq Scan on infection_numbers_influenza_20_01 t1_1
              Filter: (remarks &@~ 'age'::character varying)
        ->  Seq Scan on infection_numbers_influenza_20_02 t1_2
              Filter: (remarks &@~ 'age'::character varying)
        ->  Seq Scan on infection_numbers_influenza_20_03 t1_3
              Filter: (remarks &@~ 'age'::character varying)
        ->  Seq Scan on infection_numbers_influenza_20_04 t1_4
              Filter: (remarks &@~ 'age'::character varying)
        ->  Seq Scan on infection_numbers_influenza_21_01 t1_5
              Filter: (remarks &@~ 'age'::character varying)
        ->  Seq Scan on infection_numbers_influenza_21_02 t1_6
              Filter: (remarks &@~ 'age'::character varying)
        ->  Seq Scan on infection_numbers_influenza_21_03 t1_7
              Filter: (remarks &@~ 'age'::character varying)
        ->  Seq Scan on infection_numbers_influenza_21_04 t1_8
              Filter: (remarks &@~ 'age'::character varying)
        ->  Seq Scan on infection_numbers_influenza_22_01 t1_9
              Filter: (remarks &@~ 'age'::character varying)
        ->  Seq Scan on infection_numbers_influenza_22_02 t1_10
              Filter: (remarks &@~ 'age'::character varying)
        ->  Seq Scan on infection_numbers_influenza_22_03 t1_11
              Filter: (remarks &@~ 'age'::character varying)
        ->  Seq Scan on infection_numbers_influenza_22_04 t1_12
              Filter: (remarks &@~ 'age'::character varying)
  ->  Hash
        ->  Append
              ->  Seq Scan on infection_numbers_influenza_20_01 t2_1
              ->  Seq Scan on infection_numbers_influenza_20_02 t2_2
              ->  Seq Scan on infection_numbers_influenza_20_03 t2_3
              ->  Seq Scan on infection_numbers_influenza_20_04 t2_4
              ->  Seq Scan on infection_numbers_influenza_21_01 t2_5
              ->  Seq Scan on infection_numbers_influenza_21_02 t2_6
              ->  Seq Scan on infection_numbers_influenza_21_03 t2_7
              ->  Seq Scan on infection_numbers_influenza_21_04 t2_8
              ->  Seq Scan on infection_numbers_influenza_22_01 t2_9
              ->  Seq Scan on infection_numbers_influenza_22_02 t2_10
              ->  Seq Scan on infection_numbers_influenza_22_03 t2_11
              ->  Seq Scan on infection_numbers_influenza_22_04 t2_12
(41 rows)
\pset format aligned
SELECT t1.n_infection, t1.remarks
  FROM infection_numbers_influenza t1
  INNER JOIN infection_numbers_influenza t2
    ON t1.city = t2.prefecture
 WHERE t1.remarks  &@~ 'age';
 n_infection |                       remarks                        
-------------+------------------------------------------------------
 221         | age: 50, gender:male, overseas travel history: false
 10221       | age: 10, gender:male, overseas travel history: false
(2 rows)

DROP TABLE infection_numbers_influenza;
